<%- include('partials/header', { title: 'Student Restrictions' }) %>

<!-- Admin Layout -->
<div class="admin-layout">
    <%- include('partials/sidebar') %>
    
    <!-- Main Content -->
    <main class="admin-main-content">
        <%- include('partials/header-bar', { title: 'Student Restrictions' }) %>
        
        <!-- Content Area -->
        <div class="admin-content">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="admin-card" data-aos="fade-up">
                        <div class="admin-card-header">
                            <div>
                                <h2 class="admin-card-title">Student Restrictions Management</h2>
                                <p class="text-muted mb-0">Control student access to features and content on a per-student basis.</p>
                            </div>
                            <div class="admin-table-actions">
                                <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="openBulkRestrictions()">
                                    <i class="fas fa-users me-2"></i>
                                    Bulk Restrictions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="admin-stats-grid mb-4" data-aos="fade-up" data-aos-delay="100">
                <div class="admin-stat-card">
                    <div class="admin-stat-header">
                        <div class="admin-stat-icon warning">
                            <i class="fas fa-ban"></i>
                        </div>
                        <div class="admin-stat-trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>+2%</span>
                        </div>
                    </div>
                    <div class="admin-stat-value" id="totalRestrictions">0</div>
                    <div class="admin-stat-label">Active Restrictions</div>
                </div>

                <div class="admin-stat-card">
                    <div class="admin-stat-header">
                        <div class="admin-stat-icon danger">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="admin-stat-trend down">
                            <i class="fas fa-arrow-down"></i>
                            <span>-1%</span>
                        </div>
                    </div>
                    <div class="admin-stat-value" id="restrictedStudents">0</div>
                    <div class="admin-stat-label">Restricted Students</div>
                </div>

                <div class="admin-stat-card">
                    <div class="admin-stat-header">
                        <div class="admin-stat-icon info">
                            <i class="fas fa-homework"></i>
                        </div>
                        <div class="admin-stat-trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>+3%</span>
                        </div>
                    </div>
                    <div class="admin-stat-value" id="homeworkRestrictions">0</div>
                    <div class="admin-stat-label">Homework Restricted</div>
                </div>

                <div class="admin-stat-card">
                    <div class="admin-stat-header">
                        <div class="admin-stat-icon secondary">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="admin-stat-trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>+1%</span>
                        </div>
                    </div>
                    <div class="admin-stat-value" id="weekRestrictions">0</div>
                    <div class="admin-stat-label">Week Access Restricted</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="admin-card" data-aos="fade-up" data-aos-delay="200">
                        <div class="admin-card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 mb-3">
                                    <label class="admin-form-label">Filter by Feature</label>
                                    <select class="admin-form-select" id="featureFilter" onchange="filterRestrictions()">
                                        <option value="">All Features</option>
                                        <option value="homework_upload">Homework Upload</option>
                                        <option value="notes_access">Notes Access</option>
                                        <option value="week_access">Week Access</option>
                                        <option value="quiz_access">Quiz Access</option>
                                        <option value="past_papers_access">Past Papers Access</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="admin-form-label">Filter by Status</label>
                                    <select class="admin-form-select" id="statusFilter" onchange="filterRestrictions()">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="admin-form-label">Filter by Year</label>
                                    <select class="admin-form-select" id="yearFilter" onchange="filterRestrictions()">
                                        <option value="">All Years</option>
                                        <option value="Year 8">Year 8</option>
                                        <option value="Year 9">Year 9</option>
                                        <option value="Year 10">Year 10</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="admin-form-label">Search Student</label>
                                    <input type="text" class="admin-form-input" id="studentSearch" placeholder="Search by name or email..." onkeyup="filterRestrictions()">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="admin-form-label">Quick Actions</label>
                                    <div class="d-flex gap-2">
                                        <button class="admin-btn admin-btn-success admin-btn-sm" onclick="clearAllRestrictions()">
                                            <i class="fas fa-unlock me-1"></i>
                                            Clear All
                                        </button>
                                        <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="exportRestrictions()">
                                            <i class="fas fa-download me-1"></i>
                                            Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Table -->
            <div class="row">
                <div class="col-12">
                    <div class="admin-table-container" data-aos="fade-up" data-aos-delay="300">
                        <div class="admin-table-header">
                            <h3 class="admin-table-title">Student Restrictions</h3>
                            <div class="admin-table-actions">
                                <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="refreshRestrictions()">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="admin-table" id="restrictionsTable">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Year & Type</th>
                                        <th>Homework Upload</th>
                                        <th>Notes Access</th>
                                        <th>Week Access</th>
                                        <th>Quiz Access</th>
                                        <th>Past Papers Access</th>
                                        <th>Restricted Weeks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (students && students.length > 0) { %>
                                        <% students.forEach(student => { %>
                                            <tr data-student-id="<%= student._id %>">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="admin-user-avatar me-3" style="width: 35px; height: 35px; font-size: 14px;">
                                                            <%= student.name.charAt(0).toUpperCase() %>
                                                        </div>
                                                        <div>
                                                            <div class="fw-semibold"><%= student.name %></div>
                                                            <small class="text-muted"><%= student.email %></small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div>
                                                        <div class="fw-semibold"><%= student.year || 'N/A' %></div>
                                                        <small class="text-muted"><%= student.studentType || 'N/A' %></small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               <%= student.restrictions && student.restrictions.canAccessHomework ? 'checked' : '' %>
                                                               onchange="toggleRestriction('<%= student._id %>', 'homework_upload', this.checked)">
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               <%= student.restrictions && student.restrictions.canAccessNotes ? 'checked' : '' %>
                                                               onchange="toggleRestriction('<%= student._id %>', 'notes_access', this.checked)">
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               <%= student.restrictions && student.restrictions.canAccessWeeks ? 'checked' : '' %>
                                                               onchange="toggleRestriction('<%= student._id %>', 'week_access', this.checked)">
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               <%= student.restrictions && student.restrictions.canAccessQuiz ? 'checked' : '' %>
                                                               onchange="toggleRestriction('<%= student._id %>', 'quiz_access', this.checked)">
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               <%= student.restrictions && student.restrictions.canAccessPastPapers ? 'checked' : '' %>
                                                               onchange="toggleRestriction('<%= student._id %>', 'past_papers_access', this.checked)">
                                                    </div>
                                                </td>
                                                <td>
                                                    <% if (student.restrictions && student.restrictions.restrictedWeeks && student.restrictions.restrictedWeeks.length > 0) { %>
                                                        <div class="d-flex flex-wrap gap-1">
                                                            <% student.restrictions.restrictedWeeks.forEach(week => { %>
                                                                <span class="badge bg-danger" style="font-size: 10px;">
                                                                    Week <%= week.weekNumber %>
                                                                </span>
                                                            <% }); %>
                                                        </div>
                                                    <% } else { %>
                                                        <span class="text-muted">None</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="d-flex gap-2">
                                                        <button class="admin-btn admin-btn-info admin-btn-sm" 
                                                                onclick="manageWeekRestrictions('<%= student._id %>')" 
                                                                title="Manage Week Restrictions">
                                                            <i class="fas fa-calendar-week"></i>
                                                        </button>
                                                        <button class="admin-btn admin-btn-warning admin-btn-sm" 
                                                                onclick="viewRestrictionHistory('<%= student._id %>')" 
                                                                title="View History">
                                                            <i class="fas fa-history"></i>
                                                        </button>
                                                        <button class="admin-btn admin-btn-secondary admin-btn-sm" 
                                                                onclick="clearStudentRestrictions('<%= student._id %>')" 
                                                                title="Clear All Restrictions">
                                                            <i class="fas fa-unlock"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="8" class="text-center py-5">
                                                <div class="admin-empty-state">
                                                    <div class="admin-empty-icon">
                                                        <i class="fas fa-ban"></i>
                                                    </div>
                                                    <div class="admin-empty-title">No Students Found</div>
                                                    <div class="admin-empty-description">Student restriction data will appear here.</div>
                                                </div>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Week Restrictions Modal -->
<div class="admin-modal-overlay" id="weekRestrictionsModal">
    <div class="admin-modal" style="max-width: 800px;">
        <div class="admin-modal-header">
            <h3 class="admin-modal-title">Manage Week Restrictions</h3>
            <button class="admin-modal-close" onclick="closeWeekRestrictionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal-body" id="weekRestrictionsContent">
            <div class="admin-loading">
                <div class="admin-spinner"></div>
                Loading week restrictions...
            </div>
        </div>
        <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="closeWeekRestrictionsModal()">Cancel</button>
            <button class="admin-btn admin-btn-primary" onclick="saveWeekRestrictions()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Bulk Restrictions Modal -->
<div class="admin-modal-overlay" id="bulkRestrictionsModal">
    <div class="admin-modal" style="max-width: 900px;">
        <div class="admin-modal-header">
            <h3 class="admin-modal-title">Bulk Restrictions</h3>
            <button class="admin-modal-close" onclick="closeBulkRestrictionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal-body" id="bulkRestrictionsContent">
            <form id="bulkRestrictionsForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="admin-form-label">Select Students</label>
                        <div class="admin-card" style="max-height: 300px; overflow-y: auto;">
                            <div class="admin-card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllStudents" onchange="toggleAllStudents()">
                                    <label class="form-check-label" for="selectAllStudents">
                                        <strong>Select All Students</strong>
                                    </label>
                                </div>
                                <hr>
                                <div id="studentsList">
                                    <!-- Students will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="admin-form-label">Restriction Settings</label>
                        <div class="admin-card">
                            <div class="admin-card-body">
                                <div class="mb-3">
                                    <label class="admin-form-label">Feature Restrictions</label>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="restrictHomework" id="restrictHomework">
                                        <label class="form-check-label" for="restrictHomework">
                                            Restrict Homework Upload
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="restrictNotes" id="restrictNotes">
                                        <label class="form-check-label" for="restrictNotes">
                                            Restrict Notes Access
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="restrictWeeks" id="restrictWeeks">
                                        <label class="form-check-label" for="restrictWeeks">
                                            Restrict Week Access
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="restrictQuiz" id="restrictQuiz">
                                        <label class="form-check-label" for="restrictQuiz">
                                            Restrict Quiz Access
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="restrictPastPapers" id="restrictPastPapers">
                                        <label class="form-check-label" for="restrictPastPapers">
                                            Restrict Past Papers Access
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="admin-form-label">Specific Weeks to Restrict</label>
                                    <select class="admin-form-select" name="restrictedWeeks" multiple>
                                        <!-- Weeks will be populated here -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="admin-form-label">Reason for Restrictions</label>
                                    <textarea class="admin-form-textarea" name="reason" rows="3" 
                                              placeholder="Explain why these restrictions are being applied..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="closeBulkRestrictionsModal()">Cancel</button>
            <button class="admin-btn admin-btn-primary" onclick="applyBulkRestrictions()">Apply Restrictions</button>
        </div>
    </div>
</div>

<!-- Restriction History Modal -->
<div class="admin-modal-overlay" id="restrictionHistoryModal">
    <div class="admin-modal" style="max-width: 800px;">
        <div class="admin-modal-header">
            <h3 class="admin-modal-title">Restriction History</h3>
            <button class="admin-modal-close" onclick="closeRestrictionHistoryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal-body" id="restrictionHistoryContent">
            <div class="admin-loading">
                <div class="admin-spinner"></div>
                Loading restriction history...
            </div>
        </div>
        <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="closeRestrictionHistoryModal()">Close</button>
        </div>
    </div>
</div>

<script>
// Additional JavaScript for restrictions page
let currentStudentId = null;

// Toggle restriction
async function toggleRestriction(studentId, feature, enabled) {
    try {
        const response = await fetch(`/admin/api/students/${studentId}/restrictions`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                feature: feature,
                enabled: enabled
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(`Restriction ${enabled ? 'removed' : 'applied'} successfully!`);
            updateStatistics();
        } else {
            showError(result.message || 'Failed to update restriction');
            // Revert the checkbox state
            event.target.checked = !enabled;
        }
    } catch (error) {
        showError('An error occurred while updating the restriction');
        // Revert the checkbox state
        event.target.checked = !enabled;
    }
}

// Filter restrictions
function filterRestrictions() {
    const featureFilter = document.getElementById('featureFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const studentSearch = document.getElementById('studentSearch').value.toLowerCase();
    
    const rows = document.querySelectorAll('#restrictionsTable tbody tr');
    
    rows.forEach(row => {
        const studentName = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
        const year = row.querySelector('td:nth-child(2)').textContent.trim();
        
        const yearMatch = !yearFilter || year.includes(yearFilter);
        const searchMatch = !studentSearch || studentName.includes(studentSearch);
        
        row.style.display = (yearMatch && searchMatch) ? '' : 'none';
    });
}

// Manage week restrictions
async function manageWeekRestrictions(studentId) {
    currentStudentId = studentId;
    const modal = document.getElementById('weekRestrictionsModal');
    const content = document.getElementById('weekRestrictionsContent');
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    try {
        const response = await fetch(`/admin/api/students/${studentId}/week-restrictions`);
        const result = await response.json();
        
        if (result.success) {
            content.innerHTML = generateWeekRestrictionsHTML(result.student, result.weeks);
        } else {
            content.innerHTML = '<div class="text-center text-danger">Error loading week restrictions</div>';
        }
    } catch (error) {
        content.innerHTML = '<div class="text-center text-danger">Error loading week restrictions</div>';
    }
}

// Generate week restrictions HTML
function generateWeekRestrictionsHTML(student, weeks) {
    return `
        <div class="row">
            <div class="col-md-4">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h5 class="admin-card-title">Student Info</h5>
                    </div>
                    <div class="admin-card-body">
                        <div class="text-center mb-3">
                            <div class="admin-user-avatar mx-auto mb-2" style="width: 60px; height: 60px; font-size: 24px;">
                                ${student.name.charAt(0).toUpperCase()}
                            </div>
                            <h6>${student.name}</h6>
                            <p class="text-muted small">${student.email}</p>
                        </div>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="fw-bold text-primary">${student.year || 'N/A'}</div>
                                <small class="text-muted">Year</small>
                            </div>
                            <div class="col-6">
                                <div class="fw-bold text-info">${student.studentType || 'N/A'}</div>
                                <small class="text-muted">Type</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h5 class="admin-card-title">Week Restrictions</h5>
                    </div>
                    <div class="admin-card-body">
                        <form id="weekRestrictionsForm">
                            <div class="row">
                                ${weeks.map(week => `
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="restrictedWeeks" value="${week.weekNumber}" 
                                                   id="week${week.weekNumber}"
                                                   ${student.restrictions && student.restrictions.restrictedWeeks && 
                                                     student.restrictions.restrictedWeeks.some(rw => rw.weekNumber === week.weekNumber) ? 'checked' : ''}>
                                            <label class="form-check-label" for="week${week.weekNumber}">
                                                <strong>Week ${week.weekNumber}</strong><br>
                                                <small class="text-muted">${week.title}</small>
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mb-3">
                                <label class="admin-form-label">Reason for Restrictions</label>
                                <textarea class="admin-form-textarea" name="reason" rows="3" 
                                          placeholder="Explain why these weeks are being restricted..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Save week restrictions
async function saveWeekRestrictions() {
    const form = document.getElementById('weekRestrictionsForm');
    const formData = new FormData(form);
    const restrictedWeeks = Array.from(formData.getAll('restrictedWeeks')).map(Number);
    const reason = formData.get('reason');
    
    try {
        const response = await fetch(`/admin/api/students/${currentStudentId}/week-restrictions`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                restrictedWeeks: restrictedWeeks,
                reason: reason
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Week restrictions updated successfully!');
            closeWeekRestrictionsModal();
            window.location.reload();
        } else {
            showError(result.message || 'Failed to update week restrictions');
        }
    } catch (error) {
        showError('An error occurred while updating week restrictions');
    }
}

// Close week restrictions modal
function closeWeekRestrictionsModal() {
    const modal = document.getElementById('weekRestrictionsModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Open bulk restrictions
async function openBulkRestrictions() {
    const modal = document.getElementById('bulkRestrictionsModal');
    const studentsList = document.getElementById('studentsList');
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    try {
        const response = await fetch('/admin/api/students');
        const result = await response.json();
        
        if (result.success) {
            studentsList.innerHTML = result.students.map(student => `
                <div class="form-check mb-2">
                    <input class="form-check-input student-checkbox" type="checkbox" 
                           name="selectedStudents" value="${student._id}" id="student${student._id}">
                    <label class="form-check-label" for="student${student._id}">
                        ${student.name} (${student.email})
                    </label>
                </div>
            `).join('');
        }
    } catch (error) {
        studentsList.innerHTML = '<div class="text-center text-danger">Error loading students</div>';
    }
}

// Toggle all students
function toggleAllStudents() {
    const selectAll = document.getElementById('selectAllStudents');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    
    studentCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Apply bulk restrictions
async function applyBulkRestrictions() {
    const form = document.getElementById('bulkRestrictionsForm');
    const formData = new FormData(form);
    const selectedStudents = Array.from(formData.getAll('selectedStudents'));
    
    if (selectedStudents.length === 0) {
        showError('Please select at least one student');
        return;
    }
    
    const restrictions = {
        restrictHomework: formData.has('restrictHomework'),
        restrictNotes: formData.has('restrictNotes'),
        restrictWeeks: formData.has('restrictWeeks'),
        restrictQuiz: formData.has('restrictQuiz'),
        restrictPastPapers: formData.has('restrictPastPapers'),
        restrictedWeeks: Array.from(formData.getAll('restrictedWeeks')).map(Number),
        reason: formData.get('reason')
    };
    
    try {
        const response = await fetch('/admin/api/students/bulk-restrictions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                studentIds: selectedStudents,
                restrictions: restrictions
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(`Restrictions applied to ${selectedStudents.length} students successfully!`);
            closeBulkRestrictionsModal();
            window.location.reload();
        } else {
            showError(result.message || 'Failed to apply bulk restrictions');
        }
    } catch (error) {
        showError('An error occurred while applying bulk restrictions');
    }
}

// Close bulk restrictions modal
function closeBulkRestrictionsModal() {
    const modal = document.getElementById('bulkRestrictionsModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// View restriction history
async function viewRestrictionHistory(studentId) {
    const modal = document.getElementById('restrictionHistoryModal');
    const content = document.getElementById('restrictionHistoryContent');
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    try {
        const response = await fetch(`/admin/api/students/${studentId}/restriction-history`);
        const result = await response.json();
        
        if (result.success) {
            content.innerHTML = generateRestrictionHistoryHTML(result.history);
        } else {
            content.innerHTML = '<div class="text-center text-danger">Error loading restriction history</div>';
        }
    } catch (error) {
        content.innerHTML = '<div class="text-center text-danger">Error loading restriction history</div>';
    }
}

// Generate restriction history HTML
function generateRestrictionHistoryHTML(history) {
    if (!history || history.length === 0) {
        return '<div class="text-center text-muted">No restriction history found</div>';
    }
    
    return `
        <div class="admin-card">
            <div class="admin-card-body">
                <div class="timeline">
                    ${history.map(entry => `
                        <div class="timeline-item">
                            <div class="timeline-marker ${entry.action === 'restricted' ? 'bg-danger' : 'bg-success'}"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${entry.feature.replace('_', ' ').toUpperCase()}</h6>
                                        <p class="text-muted mb-1">${entry.reason || 'No reason provided'}</p>
                                        <small class="text-muted">${new Date(entry.createdAt).toLocaleString()}</small>
                                    </div>
                                    <span class="badge ${entry.action === 'restricted' ? 'bg-danger' : 'bg-success'}">
                                        ${entry.action === 'restricted' ? 'Restricted' : 'Unrestricted'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

// Close restriction history modal
function closeRestrictionHistoryModal() {
    const modal = document.getElementById('restrictionHistoryModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Clear student restrictions
async function clearStudentRestrictions(studentId) {
    if (confirm('Are you sure you want to clear all restrictions for this student?')) {
        try {
            const response = await fetch(`/admin/api/students/${studentId}/restrictions`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('All restrictions cleared successfully!');
                window.location.reload();
            } else {
                showError(result.message || 'Failed to clear restrictions');
            }
        } catch (error) {
            showError('An error occurred while clearing restrictions');
        }
    }
}

// Clear all restrictions
async function clearAllRestrictions() {
    if (confirm('Are you sure you want to clear all restrictions for all students? This action cannot be undone.')) {
        try {
            const response = await fetch('/admin/api/students/clear-all-restrictions', {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('All restrictions cleared successfully!');
                window.location.reload();
            } else {
                showError(result.message || 'Failed to clear all restrictions');
            }
        } catch (error) {
            showError('An error occurred while clearing all restrictions');
        }
    }
}

// Export restrictions
function exportRestrictions() {
    // Implementation for exporting restrictions data
    console.log('Exporting restrictions data');
}

// Refresh restrictions
function refreshRestrictions() {
    window.location.reload();
}

// Update statistics
function updateStatistics() {
    const totalRestrictions = document.querySelectorAll('#restrictionsTable tbody tr').length;
    const restrictedStudents = document.querySelectorAll('#restrictionsTable tbody tr').length; // This would be filtered
    const homeworkRestrictions = document.querySelectorAll('#restrictionsTable tbody tr').length; // This would be filtered
    const weekRestrictions = document.querySelectorAll('#restrictionsTable tbody tr').length; // This would be filtered
    
    document.getElementById('totalRestrictions').textContent = totalRestrictions;
    document.getElementById('restrictedStudents').textContent = restrictedStudents;
    document.getElementById('homeworkRestrictions').textContent = homeworkRestrictions;
    document.getElementById('weekRestrictions').textContent = weekRestrictions;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateStatistics();
});
</script>

<%- include('partials/footer') %>
