<%- include('partials/header', { title: 'Past Papers Management' }) %>

<!-- Admin Layout -->
<div class="admin-layout">
    <%- include('partials/sidebar') %>
    
    <!-- Main Content -->
    <main class="admin-main-content">
        <%- include('partials/header-bar', { title: 'Past Papers Management' }) %>
        
        <!-- Content Area -->
        <div class="admin-content">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="admin-card" data-aos="fade-up">
                        <div class="admin-card-header">
                            <div>
                                <h2 class="admin-card-title">Past Papers Management</h2>
                                <p class="text-muted mb-0">Manage past examination papers for all years and student types.</p>
                            </div>
                            <div>
                                <button class="admin-btn primary" onclick="openCreatePastPaperModal()">
                                    <i class="fas fa-plus"></i>
                                    Add Past Paper
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Past Papers Table -->
            <div class="row">
                <div class="col-12">
                    <div class="admin-card" data-aos="fade-up" data-aos-delay="100">
                        <div class="admin-card-header">
                            <h3 class="admin-card-title">All Past Papers</h3>
                            <div class="admin-card-actions">
                                <div class="admin-search-box">
                                    <input type="text" class="admin-search-input" placeholder="Search past papers...">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                        </div>
                        <div class="admin-card-body">
                            <div class="table-responsive">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Year</th>
                                            <th>Paper Type</th>
                                            <th>Exam Year</th>
                                            <th>Duration</th>
                                            <th>Difficulty</th>
                                            <th>Downloads</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pastPapersTableBody">
                                        <% if (pastPapers && pastPapers.length > 0) { %>
                                            <% pastPapers.forEach(paper => { %>
                                                <tr>
                                                    <td>
                                                        <div class="admin-table-cell">
                                                            <div class="admin-table-cell-title"><%= paper.title %></div>
                                                            <div class="admin-table-cell-subtitle"><%= paper.description %></div>
                                                        </div>
                                                    </td>
                                                    <td><span class="admin-badge primary"><%= paper.year %></span></td>
                                                    <td><span class="admin-badge secondary"><%= paper.paperType %></span></td>
                                                    <td><%= paper.examYear %></td>
                                                    <td><%= paper.duration %> min</td>
                                                    <td>
                                                        <span class="admin-badge <%= paper.difficulty === 'Easy' ? 'success' : paper.difficulty === 'Medium' ? 'warning' : 'danger' %>">
                                                            <%= paper.difficulty %>
                                                        </span>
                                                    </td>
                                                    <td><%= paper.downloadCount %></td>
                                                    <td>
                                                        <span class="admin-badge <%= paper.isActive ? 'success' : 'secondary' %>">
                                                            <%= paper.isActive ? 'Active' : 'Inactive' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="admin-table-actions">
                                                            <button class="admin-btn-icon" onclick="viewPastPaper('<%= paper._id %>')" title="View Details">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button class="admin-btn-icon" onclick="downloadPastPaper('<%= paper._id %>')" title="Download">
                                                                <i class="fas fa-download"></i>
                                                            </button>
                                                            <button class="admin-btn-icon" onclick="editPastPaper('<%= paper._id %>')" title="Edit">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="admin-btn-icon <%= paper.isActive ? 'warning' : 'success' %>" 
                                                                    data-paper-id="<%= paper._id %>" 
                                                                    data-action="<%= paper.isActive ? 'deactivate' : 'activate' %>"
                                                                    onclick="togglePastPaperStatus(this.dataset.paperId, this.dataset.action)" 
                                                                    title="<%= paper.isActive ? 'Deactivate' : 'Activate' %>">
                                                                <i class="fas fa-<%= paper.isActive ? 'pause' : 'play' %>"></i>
                                                            </button>
                                                            <button class="admin-btn-icon danger" onclick="deletePastPaper('<%= paper._id %>')" title="Delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <div class="admin-empty-state">
                                                        <i class="fas fa-file-pdf"></i>
                                                        <h4>No Past Papers Found</h4>
                                                        <p>Start by adding your first past paper.</p>
                                                        <button class="admin-btn primary" onclick="openCreatePastPaperModal()">
                                                            <i class="fas fa-plus"></i>
                                                            Add Past Paper
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Create Past Paper Modal -->
<div class="admin-modal-overlay" id="createPastPaperModal" style="display: none;">
    <div class="admin-modal">
        <div class="admin-modal-header">
            <h3 class="admin-modal-title">Create New Past Paper</h3>
            <button class="admin-modal-close" onclick="closeCreatePastPaperModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createPastPaperForm">
            <div class="admin-modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Title *</label>
                            <input type="text" class="admin-form-input" name="title" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Description</label>
                            <input type="text" class="admin-form-input" name="description">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Year *</label>
                            <select class="admin-form-input" name="year" required>
                                <option value="">Select Year</option>
                                <option value="Year 8">Year 8</option>
                                <option value="Year 9">Year 9</option>
                                <option value="Year 10">Year 10</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Curriculum *</label>
                            <select class="admin-form-input" name="curriculum" required>
                                <option value="">Select Curriculum</option>
                                <option value="Cambridge">Cambridge</option>
                                <option value="Edexcel">Edexcel</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-form-group">
                                        <label class="admin-form-label">Student Type *</label>
                                        <select class="admin-form-input" name="studentType" required>
                                            <option value="">Select Type</option>
                                            <option value="School">School</option>
                                            <option value="Center">Center</option>
                                            <option value="Online">Online</option>
                                            <option value="ALL">For ALL Types</option>
                                        </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Paper Type *</label>
                            <select class="admin-form-input" name="paperType" required>
                                <option value="">Select Type</option>
                                <optgroup label="Standard Papers">
                                    <option value="Paper 1">Paper 1</option>
                                    <option value="Paper 2">Paper 2</option>
                                    <option value="Paper 3">Paper 3</option>
                                    <option value="Paper 4">Paper 4</option>
                              
                                </optgroup>
                                <optgroup label="Higher Papers">
                                    <option value="Paper 1H">Paper 1H</option>
                                    <option value="Paper 2H">Paper 2H</option>
                              
                                </optgroup>
                                <optgroup label="Units">
                                    <option value="Unit One">Unit One</option>
                                    <option value="Unit Two">Unit Two</option>
                           
                                </optgroup>
                      
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Exam Year *</label>
                            <input type="number" class="admin-form-input" name="examYear" min="2020" max="<%= new Date().getFullYear() %>" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Duration (minutes) *</label>
                            <input type="number" class="admin-form-input" name="duration" min="30" max="180" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Total Marks *</label>
                            <input type="number" class="admin-form-input" name="totalMarks" min="50" max="200" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Difficulty</label>
                            <select class="admin-form-input" name="difficulty">
                                <option value="Easy">Easy</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Calculator Allowed</label>
                            <select class="admin-form-input" name="calculatorAllowed">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="admin-form-group">
                    <label class="admin-form-label">Topics (comma-separated)</label>
                    <input type="text" class="admin-form-input" name="topics" placeholder="Algebra, Geometry, Statistics">
                </div>

                <div class="admin-form-group">
                    <label class="admin-form-label">Main Paper File *</label>
                    <input type="file" class="admin-form-input" name="paperFile" accept=".pdf" required>
                    <small class="form-text text-muted">Upload the main past paper PDF file (max 10MB)</small>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Answer Key File</label>
                            <input type="file" class="admin-form-input" name="answerKeyFile" accept=".pdf">
                            <small class="form-text text-muted">Upload answer key PDF (optional)</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Marking Scheme File</label>
                            <input type="file" class="admin-form-input" name="markingSchemeFile" accept=".pdf">
                            <small class="form-text text-muted">Upload marking scheme PDF (optional)</small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Access Level</label>
                            <select class="admin-form-input" name="accessLevel">
                                <option value="public">Public - All students can access</option>
                                <option value="restricted">Restricted - Only selected students</option>
                                <option value="private">Private - Only specific students</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Allow Preview</label>
                            <select class="admin-form-input" name="allowPreview">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="admin-form-group">
                    <label class="admin-form-label">Preview Pages</label>
                    <input type="number" class="admin-form-input" name="previewPages" min="1" max="10" value="3">
                    <small class="form-text text-muted">Number of pages students can preview (1-10)</small>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button type="button" class="admin-btn secondary" onclick="closeCreatePastPaperModal()">Cancel</button>
                <button type="submit" class="admin-btn primary">Create Past Paper</button>
            </div>
        </form>
    </div>
</div>

<%- include('partials/footer') %>

<style>
/* Additional styles for past papers modal */
.admin-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.admin-modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.admin-modal {
    background: var(--math-bg);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.admin-modal-overlay.show .admin-modal {
    transform: scale(1);
}

/* Close modal when clicking outside */
.admin-modal-overlay {
    cursor: pointer;
}

.admin-modal {
    cursor: default;
}

/* Notification styles */
.alert {
    padding: 12px 20px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}

.btn-close {
    background: none;
    border: none;
    font-size: 18px;
    font-weight: bold;
    color: inherit;
    opacity: 0.5;
    cursor: pointer;
    float: right;
    margin-left: 10px;
}

.btn-close:hover {
    opacity: 0.75;
}
</style>

<script>
// Notification functions
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function showSuccess(message) {
    showNotification(message, 'success');
}

function showError(message) {
    showNotification(message, 'error');
}

// Past Paper Management Functions
function openCreatePastPaperModal() {
    const modal = document.getElementById('createPastPaperModal');
    modal.style.display = 'flex';
    modal.classList.add('show');
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeCreatePastPaperModal();
        }
    });
    
    // Close modal with ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCreatePastPaperModal();
        }
    });
}

function closeCreatePastPaperModal() {
    const modal = document.getElementById('createPastPaperModal');
    modal.style.display = 'none';
    modal.classList.remove('show');
    document.getElementById('createPastPaperForm').reset();
}

// Handle form submission
document.getElementById('createPastPaperForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    
    // Validate file size (10MB limit)
    const paperFile = formData.get('paperFile');
    if (paperFile && paperFile.size > 10 * 1024 * 1024) {
        showNotification('File size must be less than 10MB', 'error');
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
        return;
    }
    
    try {
        const response = await fetch('/admin/past-papers/create', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Past paper created successfully!', 'success');
            closeCreatePastPaperModal();
            setTimeout(() => {
            location.reload();
            }, 1000);
        } else {
            showNotification(result.message || 'Error creating past paper', 'error');
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error creating past paper', 'error');
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
    }
});

async function viewPastPaper(paperId) {
    try {
        const response = await fetch(`/admin/past-papers/${paperId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show past paper details in a modal
            showPastPaperDetailsModal(result.pastPaper);
        } else {
            showNotification(result.message || 'Error loading past paper details', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error loading past paper details', 'error');
    }
}

function downloadPastPaper(paperId) {
    try {
        // Show notification first
        showNotification('Starting download...', 'info');
        
        // Open the download URL directly in a new tab or trigger download
        window.open(`/admin/past-papers/${paperId}/download`, '_blank');
        
        // Show success notification after a short delay
        setTimeout(() => {
            showNotification('Past paper download started!', 'success');
        }, 1000);
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error downloading past paper', 'error');
    }
}

async function editPastPaper(paperId) {
    try {
        const response = await fetch(`/admin/past-papers/${paperId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Open edit modal with pre-filled data
            openEditPastPaperModal(result.pastPaper);
        } else {
            showNotification(result.message || 'Error loading past paper for editing', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error loading past paper for editing', 'error');
    }
}

async function deletePastPaper(paperId) {
    if (confirm('Are you sure you want to delete this past paper? This action cannot be undone.')) {
        showNotification('Deleting past paper...', 'info');
        
        try {
            const response = await fetch(`/admin/past-papers/${paperId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Past paper deleted successfully!', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification(result.message || 'Error deleting past paper', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error deleting past paper', 'error');
        }
    }
}

async function togglePastPaperStatus(paperId, action) {
    showNotification(`${action === 'activate' ? 'Activating' : 'Deactivating'} past paper...`, 'info');
    
    try {
        const response = await fetch(`/admin/past-papers/${paperId}/toggle-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ action })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`Past paper ${action}d successfully!`, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(result.message || `Error ${action}ing past paper`, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification(`Error ${action}ing past paper`, 'error');
    }
}

function showPastPaperDetailsModal(paper) {
    // Create and show a modal with past paper details
    const modal = document.createElement('div');
    modal.className = 'admin-modal-overlay show';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="admin-modal">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title">Past Paper Details</h3>
                <button class="admin-modal-close" onclick="this.closest('.admin-modal-overlay').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="admin-modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Basic Information</h5>
                        <p><strong>Title:</strong> ${paper.title}</p>
                        <p><strong>Description:</strong> ${paper.description || 'N/A'}</p>
                        <p><strong>Year:</strong> ${paper.year}</p>
                        <p><strong>Paper Type:</strong> ${paper.paperType}</p>
                        <p><strong>Exam Year:</strong> ${paper.examYear}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Paper Details</h5>
                        <p><strong>Duration:</strong> ${paper.duration} minutes</p>
                        <p><strong>Total Marks:</strong> ${paper.totalMarks}</p>
                        <p><strong>Difficulty:</strong> ${paper.difficulty}</p>
                        <p><strong>Calculator Allowed:</strong> ${paper.calculatorAllowed ? 'Yes' : 'No'}</p>
                        <p><strong>Status:</strong> ${paper.isActive ? 'Active' : 'Inactive'}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Access Control</h5>
                        <p><strong>Access Level:</strong> ${paper.accessControl?.accessLevel || 'public'}</p>
                        <p><strong>Allow Preview:</strong> ${paper.allowPreview ? 'Yes' : 'No'}</p>
                        <p><strong>Preview Pages:</strong> ${paper.previewPages || 3}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Statistics</h5>
                        <p><strong>Downloads:</strong> ${paper.downloadCount || 0}</p>
                        <p><strong>Views:</strong> ${paper.viewCount || 0}</p>
                        <p><strong>Created:</strong> ${new Date(paper.createdAt).toLocaleDateString()}</p>
                    </div>
                </div>
                ${paper.topics && paper.topics.length > 0 ? `
                    <div class="row">
                        <div class="col-12">
                            <h5>Topics</h5>
                            <p>${paper.topics.join(', ')}</p>
                        </div>
                    </div>
                ` : ''}
            </div>
            <div class="admin-modal-footer">
                <button class="admin-btn secondary" onclick="this.closest('.admin-modal-overlay').remove()">Close</button>
                <button class="admin-btn info" onclick="downloadPastPaper('${paper._id}')">
                    <i class="fas fa-download"></i>
                    Download
                </button>
                <button class="admin-btn primary" onclick="editPastPaper('${paper._id}'); this.closest('.admin-modal-overlay').remove();">Edit</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openEditPastPaperModal(paper) {
    // Implementation for edit modal
    console.log('Edit modal for paper:', paper);
    // This would open a modal similar to create but pre-filled with paper data
}
</script>
