<%- include('partials/header', { title: 'System Settings' }) %>

<!-- Admin Layout -->
<div class="admin-layout">
    <%- include('partials/sidebar') %>
    
    <!-- Main Content -->
    <main class="admin-main-content">
        <%- include('partials/header-bar', { title: 'System Settings' }) %>
        
        <!-- Content Area -->
        <div class="admin-content">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="admin-card" data-aos="fade-up">
                        <div class="admin-card-header">
                            <div>
                                <h2 class="admin-card-title">System Settings</h2>
                                <p class="text-muted mb-0">Configure system-wide settings, preferences, and platform behavior.</p>
                            </div>
                            <div class="admin-table-actions">
                                <button class="admin-btn admin-btn-success admin-btn-sm" onclick="saveAllSettings()">
                                    <i class="fas fa-save me-2"></i>
                                    Save All Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tabs -->
            <div class="row">
                <div class="col-12">
                    <div class="admin-card" data-aos="fade-up" data-aos-delay="100">
                        <div class="admin-card-body">
                            <ul class="nav nav-tabs admin-nav-tabs" id="settingsTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                        <i class="fas fa-cog me-2"></i>General
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="academic-tab" data-bs-toggle="tab" data-bs-target="#academic" type="button" role="tab">
                                        <i class="fas fa-graduation-cap me-2"></i>Academic
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                                        <i class="fas fa-bell me-2"></i>Notifications
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                                        <i class="fas fa-shield-alt me-2"></i>Security
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                                        <i class="fas fa-database me-2"></i>Backup & Maintenance
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content admin-tab-content" id="settingsTabContent">
                                <!-- General Settings -->
                                <div class="tab-pane fade show active" id="general" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Platform Information</h5>
                                            <form id="generalSettingsForm">
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Platform Name</label>
                                                    <input type="text" class="admin-form-input" name="platformName" 
                                                           value="Mr Moharram - IG Math Learning Platform" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Platform Description</label>
                                                    <textarea class="admin-form-textarea" name="platformDescription" rows="3">Interactive mathematics learning platform for IGCSE, AS, and A2 students.</textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Contact Email</label>
                                                    <input type="email" class="admin-form-input" name="contactEmail" 
                                                           value="admin@mrMoharram.com" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Support Phone</label>
                                                    <input type="tel" class="admin-form-input" name="supportPhone" 
                                                           value="+1 (555) 123-4567">
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="mb-3">System Preferences</h5>
                                            <form id="systemPreferencesForm">
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Default Timezone</label>
                                                    <select class="admin-form-select" name="timezone">
                                                        <option value="UTC">UTC</option>
                                                        <option value="America/New_York">Eastern Time</option>
                                                        <option value="America/Chicago">Central Time</option>
                                                        <option value="America/Denver">Mountain Time</option>
                                                        <option value="America/Los_Angeles">Pacific Time</option>
                                                        <option value="Europe/London">London</option>
                                                        <option value="Europe/Paris">Paris</option>
                                                        <option value="Asia/Dubai">Dubai</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Date Format</label>
                                                    <select class="admin-form-select" name="dateFormat">
                                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                                        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Language</label>
                                                    <select class="admin-form-select" name="language">
                                                        <option value="en">English</option>
                                                        <option value="ar">Arabic</option>
                                                        <option value="fr">French</option>
                                                        <option value="es">Spanish</option>
                                                    </select>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="maintenanceMode" id="maintenanceMode">
                                                    <label class="form-check-label" for="maintenanceMode">
                                                        Enable Maintenance Mode
                                                    </label>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Academic Settings -->
                                <div class="tab-pane fade" id="academic" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Academic Configuration</h5>
                                            <form id="academicSettingsForm">
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Academic Year Start</label>
                                                    <input type="date" class="admin-form-input" name="academicYearStart" 
                                                           value="2024-09-01">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Academic Year End</label>
                                                    <input type="date" class="admin-form-input" name="academicYearEnd" 
                                                           value="2025-06-30">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Default Homework Deadline (days)</label>
                                                    <input type="number" class="admin-form-input" name="homeworkDeadline" 
                                                           value="7" min="1" max="30">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Maximum File Upload Size (MB)</label>
                                                    <input type="number" class="admin-form-input" name="maxFileSize" 
                                                           value="10" min="1" max="100">
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Grading System</h5>
                                            <form id="gradingSettingsForm">
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Default Grading Scale</label>
                                                    <select class="admin-form-select" name="gradingScale">
                                                        <option value="percentage">Percentage (0-100)</option>
                                                        <option value="letter">Letter Grade (A-F)</option>
                                                        <option value="points">Points (0-1000)</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Passing Grade (%)</label>
                                                    <input type="number" class="admin-form-input" name="passingGrade" 
                                                           value="60" min="0" max="100">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Auto-Grade Quizzes</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="autoGradeQuizzes" id="autoGradeQuizzes" checked>
                                                        <label class="form-check-label" for="autoGradeQuizzes">
                                                            Automatically grade multiple choice quizzes
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Grade Release Policy</label>
                                                    <select class="admin-form-select" name="gradeReleasePolicy">
                                                        <option value="immediate">Immediate</option>
                                                        <option value="after_deadline">After Deadline</option>
                                                        <option value="manual">Manual Release</option>
                                                    </select>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notifications Settings -->
                                <div class="tab-pane fade" id="notifications" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Email Notifications</h5>
                                            <form id="emailNotificationsForm">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="emailEnabled" id="emailEnabled" checked>
                                                    <label class="form-check-label" for="emailEnabled">
                                                        Enable Email Notifications
                                                    </label>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">SMTP Server</label>
                                                    <input type="text" class="admin-form-input" name="smtpServer" 
                                                           value="smtp.gmail.com">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">SMTP Port</label>
                                                    <input type="number" class="admin-form-input" name="smtpPort" 
                                                           value="587">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">SMTP Username</label>
                                                    <input type="email" class="admin-form-input" name="smtpUsername" 
                                                           value="noreply@mrMoharram.com">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">SMTP Password</label>
                                                    <input type="password" class="admin-form-input" name="smtpPassword" 
                                                           placeholder="Enter SMTP password">
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Notification Types</h5>
                                            <form id="notificationTypesForm">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="homeworkReminders" id="homeworkReminders" checked>
                                                    <label class="form-check-label" for="homeworkReminders">
                                                        Homework Reminders
                                                    </label>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="gradeNotifications" id="gradeNotifications" checked>
                                                    <label class="form-check-label" for="gradeNotifications">
                                                        Grade Notifications
                                                    </label>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="systemUpdates" id="systemUpdates" checked>
                                                    <label class="form-check-label" for="systemUpdates">
                                                        System Updates
                                                    </label>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="weeklyReports" id="weeklyReports">
                                                    <label class="form-check-label" for="weeklyReports">
                                                        Weekly Progress Reports
                                                    </label>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Notification Frequency</label>
                                                    <select class="admin-form-select" name="notificationFrequency">
                                                        <option value="immediate">Immediate</option>
                                                        <option value="daily">Daily Digest</option>
                                                        <option value="weekly">Weekly Summary</option>
                                                    </select>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security Settings -->
                                <div class="tab-pane fade" id="security" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Authentication</h5>
                                            <form id="authenticationSettingsForm">
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Session Timeout (minutes)</label>
                                                    <input type="number" class="admin-form-input" name="sessionTimeout" 
                                                           value="120" min="15" max="1440">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Maximum Login Attempts</label>
                                                    <input type="number" class="admin-form-input" name="maxLoginAttempts" 
                                                           value="5" min="3" max="10">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Account Lockout Duration (minutes)</label>
                                                    <input type="number" class="admin-form-input" name="lockoutDuration" 
                                                           value="30" min="5" max="1440">
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="requireStrongPasswords" id="requireStrongPasswords" checked>
                                                    <label class="form-check-label" for="requireStrongPasswords">
                                                        Require Strong Passwords
                                                    </label>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Access Control</h5>
                                            <form id="accessControlForm">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="allowStudentRegistration" id="allowStudentRegistration">
                                                    <label class="form-check-label" for="allowStudentRegistration">
                                                        Allow Student Self-Registration
                                                    </label>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="requireEmailVerification" id="requireEmailVerification" checked>
                                                    <label class="form-check-label" for="requireEmailVerification">
                                                        Require Email Verification
                                                    </label>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="allowGuestAccess" id="allowGuestAccess">
                                                    <label class="form-check-label" for="allowGuestAccess">
                                                        Allow Guest Access
                                                    </label>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">IP Whitelist (comma-separated)</label>
                                                    <textarea class="admin-form-textarea" name="ipWhitelist" rows="3" 
                                                              placeholder="192.168.1.1, 10.0.0.1"></textarea>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Backup & Maintenance -->
                                <div class="tab-pane fade" id="backup" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="mb-3">Backup Settings</h5>
                                            <form id="backupSettingsForm">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="autoBackup" id="autoBackup" checked>
                                                    <label class="form-check-label" for="autoBackup">
                                                        Enable Automatic Backups
                                                    </label>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Backup Frequency</label>
                                                    <select class="admin-form-select" name="backupFrequency">
                                                        <option value="daily">Daily</option>
                                                        <option value="weekly">Weekly</option>
                                                        <option value="monthly">Monthly</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Backup Retention (days)</label>
                                                    <input type="number" class="admin-form-input" name="backupRetention" 
                                                           value="30" min="7" max="365">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Backup Location</label>
                                                    <input type="text" class="admin-form-input" name="backupLocation" 
                                                           value="/backups" readonly>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button type="button" class="admin-btn admin-btn-primary admin-btn-sm" onclick="createBackup()">
                                                        <i class="fas fa-download me-2"></i>
                                                        Create Backup Now
                                                    </button>
                                                    <button type="button" class="admin-btn admin-btn-info admin-btn-sm" onclick="restoreBackup()">
                                                        <i class="fas fa-upload me-2"></i>
                                                        Restore from Backup
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="mb-3">System Maintenance</h5>
                                            <form id="maintenanceSettingsForm">
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Log Retention (days)</label>
                                                    <input type="number" class="admin-form-input" name="logRetention" 
                                                           value="90" min="7" max="365">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="admin-form-label">Cache Duration (hours)</label>
                                                    <input type="number" class="admin-form-input" name="cacheDuration" 
                                                           value="24" min="1" max="168">
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="autoOptimize" id="autoOptimize" checked>
                                                    <label class="form-check-label" for="autoOptimize">
                                                        Auto-optimize Database
                                                    </label>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="autoCleanup" id="autoCleanup" checked>
                                                    <label class="form-check-label" for="autoCleanup">
                                                        Auto-cleanup Temporary Files
                                                    </label>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button type="button" class="admin-btn admin-btn-warning admin-btn-sm" onclick="clearCache()">
                                                        <i class="fas fa-broom me-2"></i>
                                                        Clear Cache
                                                    </button>
                                                    <button type="button" class="admin-btn admin-btn-info admin-btn-sm" onclick="optimizeDatabase()">
                                                        <i class="fas fa-database me-2"></i>
                                                        Optimize Database
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Backup Restore Modal -->
<div class="admin-modal-overlay" id="backupRestoreModal">
    <div class="admin-modal">
        <div class="admin-modal-header">
            <h3 class="admin-modal-title">Restore from Backup</h3>
            <button class="admin-modal-close" onclick="closeBackupRestoreModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> Restoring from backup will replace all current data. This action cannot be undone.
            </div>
            <form id="backupRestoreForm">
                <div class="mb-3">
                    <label class="admin-form-label">Select Backup File</label>
                    <input type="file" class="admin-form-input" name="backupFile" accept=".sql,.json" required>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="confirmRestore" id="confirmRestore" required>
                    <label class="form-check-label" for="confirmRestore">
                        I understand this will replace all current data
                    </label>
                </div>
            </form>
        </div>
        <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="closeBackupRestoreModal()">Cancel</button>
            <button class="admin-btn admin-btn-danger" onclick="confirmRestore()">Restore Backup</button>
        </div>
    </div>
</div>

<script>
// Additional JavaScript for settings page
let settingsChanged = false;

// Save all settings
async function saveAllSettings() {
    const forms = [
        'generalSettingsForm',
        'systemPreferencesForm', 
        'academicSettingsForm',
        'gradingSettingsForm',
        'emailNotificationsForm',
        'notificationTypesForm',
        'authenticationSettingsForm',
        'accessControlForm',
        'backupSettingsForm',
        'maintenanceSettingsForm'
    ];
    
    const allSettings = {};
    
    forms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form) {
            const formData = new FormData(form);
            const settings = Object.fromEntries(formData.entries());
            Object.assign(allSettings, settings);
        }
    });
    
    try {
        const response = await fetch('/admin/api/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(allSettings)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('All settings saved successfully!');
            settingsChanged = false;
        } else {
            showError(result.message || 'Failed to save settings');
        }
    } catch (error) {
        showError('An error occurred while saving settings');
    }
}

// Create backup
async function createBackup() {
    try {
        const response = await fetch('/admin/api/backup/create', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Backup created successfully!');
        } else {
            showError(result.message || 'Failed to create backup');
        }
    } catch (error) {
        showError('An error occurred while creating backup');
    }
}

// Restore backup
function restoreBackup() {
    const modal = document.getElementById('backupRestoreModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// Close backup restore modal
function closeBackupRestoreModal() {
    const modal = document.getElementById('backupRestoreModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Confirm restore
async function confirmRestore() {
    const form = document.getElementById('backupRestoreForm');
    const formData = new FormData(form);
    const backupFile = formData.get('backupFile');
    
    if (!backupFile) {
        showError('Please select a backup file');
        return;
    }
    
    try {
        const response = await fetch('/admin/api/backup/restore', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Backup restored successfully!');
            closeBackupRestoreModal();
        } else {
            showError(result.message || 'Failed to restore backup');
        }
    } catch (error) {
        showError('An error occurred while restoring backup');
    }
}

// Clear cache
async function clearCache() {
    if (confirm('Are you sure you want to clear the cache?')) {
        try {
            const response = await fetch('/admin/api/cache/clear', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('Cache cleared successfully!');
            } else {
                showError(result.message || 'Failed to clear cache');
            }
        } catch (error) {
            showError('An error occurred while clearing cache');
        }
    }
}

// Optimize database
async function optimizeDatabase() {
    if (confirm('Are you sure you want to optimize the database?')) {
        try {
            const response = await fetch('/admin/api/database/optimize', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('Database optimized successfully!');
            } else {
                showError(result.message || 'Failed to optimize database');
            }
        } catch (error) {
            showError('An error occurred while optimizing database');
        }
    }
}

// Track settings changes
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        form.addEventListener('change', function() {
            settingsChanged = true;
        });
    });
    
    // Warn before leaving if settings changed
    window.addEventListener('beforeunload', function(e) {
        if (settingsChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
});

// Load settings on page load
async function loadSettings() {
    try {
        const response = await fetch('/admin/api/settings');
        const result = await response.json();
        
        if (result.success) {
            // Populate forms with loaded settings
            Object.keys(result.settings).forEach(key => {
                const element = document.querySelector(`[name="${key}"]`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = result.settings[key];
                    } else {
                        element.value = result.settings[key];
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});
</script>

<%- include('partials/footer') %>
